<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>K-Movie A Archive – 홈</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    /* 페이지 전용 살짝 보정 */
    .tl-legend { color:#666; font-size:13px; margin:8px 0 0; }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>K-Movie A Archive</h1>
    <div class="spacer"></div>
    <a href="index.html" class="btn">홈</a>
    <a href="search.html" class="btn">영화 검색</a>
    <a href="people-search.html" class="btn">배우 검색</a>
    <a href="saved.html" class="btn">저장 목록</a>
  </div>

  <h2>🗓️ 월간 타임라인</h2>
  <div style="display:flex; align-items:center; gap:6px; margin:8px 0 10px;">
    <button id="tlPrevBtn" class="btn">◀</button>
    <strong id="tlRangeLabel" style="min-width:210px; text-align:center;"></strong>
    <button id="tlNextBtn" class="btn">▶</button>
  </div>
  <div id="timelineBar" class="tl-bar"></div>
  <div id="tlPanel" class="tl-panel">날짜를 클릭하면 해당일 개봉 영화가 표시됩니다.</div>
  <div class="tl-legend">초록 점(•) 표시: 해당 날짜에 개봉작 존재</div>
</div>

<script>
/** 인덱스(JSON) 경로 - 캐시 무시를 위해 v 파라미터 추가 */
const MOVIE_INDEX_URL = 'data/search/movies.json?v=' + Date.now();
const DETAIL_PAGE_URL = 'detail.html';
const WINDOW_DAYS = 30;

const bar   = document.getElementById('timelineBar');
const panel = document.getElementById('tlPanel');
const label = document.getElementById('tlRangeLabel');
const prev  = document.getElementById('tlPrevBtn');
const next  = document.getElementById('tlNextBtn');

const pad2 = v => String(v).padStart(2,'0');
const ymd  = d => d.getFullYear() + pad2(d.getMonth()+1) + pad2(d.getDate());
const fmtKR = d => `${d.getFullYear()}.${pad2(d.getMonth()+1)}.${pad2(d.getDate())}`;

let dateMap = {}; // {"YYYYMMDD":[{movieCd,movieNm,openDt,grade?,nation?},...]}

async function loadIndex() {
  const res = await fetch(MOVIE_INDEX_URL);
  if (!res.ok) throw new Error('index http ' + res.status);
  const j = await res.json();

  const byDate = j.by_date || j.byDate || null;
  if (byDate && typeof byDate === 'object') {
    dateMap = byDate;
    return;
  }

  // by_date가 없으면 movies 배열을 날짜별로 묶어 만든다.
  const list = j.movies || [];
  dateMap = {};
  for (const m of list) {
    const d = String(m.openDt || '').replace(/\D/g,'');
    if (!d) continue;
    (dateMap[d] ||= []).push(m);
  }
}

function renderWindow(start) {
  bar.innerHTML = '';
  panel.innerHTML = '날짜를 클릭하면 해당일 개봉 영화가 표시됩니다.';
  const end = new Date(start); end.setDate(end.getDate() + WINDOW_DAYS - 1);
  label.textContent = `${fmtKR(start)} ~ ${fmtKR(end)}`;

  for (let i=0; i<WINDOW_DAYS; i++) {
    const d = new Date(start); d.setDate(d.getDate() + i);
    const key = ymd(d);
    const cell = document.createElement('div');
    cell.className = 'tl-day';
    if (ymd(d) === ymd(new Date())) cell.classList.add('today');
    if ((dateMap[key] || []).length) cell.classList.add('hasMovies');

    const dow = '일월화수목금토'[d.getDay()];
    cell.innerHTML = `
      <span class="d-label">${pad2(d.getMonth()+1)}/${pad2(d.getDate())}</span>
      <span style="font-size:11px; color:#777">${dow}</span>
    `;
    cell.addEventListener('click', () => {
      const list = (dateMap[key] || []).slice().sort((a,b)=> (+(b.openDt||0)-(+(a.openDt||0))));
      if (!list.length) {
        panel.innerHTML = `📭 <strong>${fmtKR(d)}</strong> 개봉작이 없습니다.`;
        return;
      }
      const wrap = document.createElement('div');
      for (const m of list) {
        const open = String(m.openDt||'').replace(/\D/g,'');
        const openFmt = open ? `${open.slice(0,4)}.${open.slice(4,6)}.${open.slice(6,8)}` : '';
        const row = document.createElement('div');
        row.innerHTML =
          `<a href="${DETAIL_PAGE_URL}?movieCd=${encodeURIComponent(m.movieCd)}"><strong>${m.movieNm}</strong></a>
           <span class="muted"> (${openFmt})</span>
           ${m.grade ? `<span class="badge">[${m.grade}]</span>` : ''}`;
        wrap.appendChild(row);
      }
      panel.innerHTML = ''; panel.appendChild(wrap);
    });
    bar.appendChild(cell);
  }
}

let start = new Date();
start.setDate(start.getDate() - Math.floor(WINDOW_DAYS/2));

(async function init(){
  try {
    bar.textContent = '인덱스 불러오는 중…';
    await loadIndex();
    renderWindow(start);
  } catch(e) {
    console.error(e);
    panel.innerHTML = `<div style="color:#b00020;">인덱스를 불러오지 못했습니다. (data/search/movies.json 확인)</div>`;
  }
})();

prev.addEventListener('click', () => { start.setDate(start.getDate()-WINDOW_DAYS); renderWindow(start); });
next.addEventListener('click', () => { start.setDate(start.getDate()+WINDOW_DAYS); renderWindow(start); });
</script>
</body>
</html>
