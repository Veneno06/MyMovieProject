<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>K-Movie A Archive â€“ í™ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    /* í˜ì´ì§€ ì „ìš© ì‚´ì§ ë³´ì • */
    .tl-legend { color:#666; font-size:13px; margin:8px 0 0; }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>K-Movie A Archive</h1>
    <div class="spacer"></div>
    <a href="index.html" class="btn">í™ˆ</a>
    <a href="search.html" class="btn">ì˜í™” ê²€ìƒ‰</a>
    <a href="people-search.html" class="btn">ë°°ìš° ê²€ìƒ‰</a>
    <a href="saved.html" class="btn">ì €ì¥ ëª©ë¡</a>
  </div>

  <h2>ğŸ—“ï¸ ì›”ê°„ íƒ€ì„ë¼ì¸</h2>
  <div style="display:flex; align-items:center; gap:6px; margin:8px 0 10px;">
    <button id="tlPrevBtn" class="btn">â—€</button>
    <strong id="tlRangeLabel" style="min-width:210px; text-align:center;"></strong>
    <button id="tlNextBtn" class="btn">â–¶</button>
  </div>
  <div id="timelineBar" class="tl-bar"></div>
  <div id="tlPanel" class="tl-panel">ë‚ ì§œë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ì¼ ê°œë´‰ ì˜í™”ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
  <div class="tl-legend">ì´ˆë¡ ì (â€¢) í‘œì‹œ: í•´ë‹¹ ë‚ ì§œì— ê°œë´‰ì‘ ì¡´ì¬</div>
</div>

<script>
/** ì¸ë±ìŠ¤(JSON) ê²½ë¡œ - ìºì‹œ ë¬´ì‹œë¥¼ ìœ„í•´ v íŒŒë¼ë¯¸í„° ì¶”ê°€ */
const MOVIE_INDEX_URL = 'data/search/movies.json?v=' + Date.now();
const DETAIL_PAGE_URL = 'detail.html';
const WINDOW_DAYS = 30;

const bar   = document.getElementById('timelineBar');
const panel = document.getElementById('tlPanel');
const label = document.getElementById('tlRangeLabel');
const prev  = document.getElementById('tlPrevBtn');
const next  = document.getElementById('tlNextBtn');

const pad2 = v => String(v).padStart(2,'0');
const ymd  = d => d.getFullYear() + pad2(d.getMonth()+1) + pad2(d.getDate());
const fmtKR = d => `${d.getFullYear()}.${pad2(d.getMonth()+1)}.${pad2(d.getDate())}`;

let dateMap = {}; // {"YYYYMMDD":[{movieCd,movieNm,openDt,grade?,nation?},...]}

async function loadIndex() {
  const res = await fetch(MOVIE_INDEX_URL);
  if (!res.ok) throw new Error('index http ' + res.status);
  const j = await res.json();

  const byDate = j.by_date || j.byDate || null;
  if (byDate && typeof byDate === 'object') {
    dateMap = byDate;
    return;
  }

  // by_dateê°€ ì—†ìœ¼ë©´ movies ë°°ì—´ì„ ë‚ ì§œë³„ë¡œ ë¬¶ì–´ ë§Œë“ ë‹¤.
  const list = j.movies || [];
  dateMap = {};
  for (const m of list) {
    const d = String(m.openDt || '').replace(/\D/g,'');
    if (!d) continue;
    (dateMap[d] ||= []).push(m);
  }
}

function renderWindow(start) {
  bar.innerHTML = '';
  panel.innerHTML = 'ë‚ ì§œë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ì¼ ê°œë´‰ ì˜í™”ê°€ í‘œì‹œë©ë‹ˆë‹¤.';
  const end = new Date(start); end.setDate(end.getDate() + WINDOW_DAYS - 1);
  label.textContent = `${fmtKR(start)} ~ ${fmtKR(end)}`;

  for (let i=0; i<WINDOW_DAYS; i++) {
    const d = new Date(start); d.setDate(d.getDate() + i);
    const key = ymd(d);
    const cell = document.createElement('div');
    cell.className = 'tl-day';
    if (ymd(d) === ymd(new Date())) cell.classList.add('today');
    if ((dateMap[key] || []).length) cell.classList.add('hasMovies');

    const dow = 'ì¼ì›”í™”ìˆ˜ëª©ê¸ˆí† '[d.getDay()];
    cell.innerHTML = `
      <span class="d-label">${pad2(d.getMonth()+1)}/${pad2(d.getDate())}</span>
      <span style="font-size:11px; color:#777">${dow}</span>
    `;
    cell.addEventListener('click', () => {
      const list = (dateMap[key] || []).slice().sort((a,b)=> (+(b.openDt||0)-(+(a.openDt||0))));
      if (!list.length) {
        panel.innerHTML = `ğŸ“­ <strong>${fmtKR(d)}</strong> ê°œë´‰ì‘ì´ ì—†ìŠµë‹ˆë‹¤.`;
        return;
      }
      const wrap = document.createElement('div');
      for (const m of list) {
        const open = String(m.openDt||'').replace(/\D/g,'');
        const openFmt = open ? `${open.slice(0,4)}.${open.slice(4,6)}.${open.slice(6,8)}` : '';
        const row = document.createElement('div');
        row.innerHTML =
          `<a href="${DETAIL_PAGE_URL}?movieCd=${encodeURIComponent(m.movieCd)}"><strong>${m.movieNm}</strong></a>
           <span class="muted"> (${openFmt})</span>
           ${m.grade ? `<span class="badge">[${m.grade}]</span>` : ''}`;
        wrap.appendChild(row);
      }
      panel.innerHTML = ''; panel.appendChild(wrap);
    });
    bar.appendChild(cell);
  }
}

let start = new Date();
start.setDate(start.getDate() - Math.floor(WINDOW_DAYS/2));

(async function init(){
  try {
    bar.textContent = 'ì¸ë±ìŠ¤ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦';
    await loadIndex();
    renderWindow(start);
  } catch(e) {
    console.error(e);
    panel.innerHTML = `<div style="color:#b00020;">ì¸ë±ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (data/search/movies.json í™•ì¸)</div>`;
  }
})();

prev.addEventListener('click', () => { start.setDate(start.getDate()-WINDOW_DAYS); renderWindow(start); });
next.addEventListener('click', () => { start.setDate(start.getDate()+WINDOW_DAYS); renderWindow(start); });
</script>
</body>
</html>
