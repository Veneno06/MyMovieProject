<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>K-Movie A Archive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    .hdr { display:flex; gap:12px; align-items:center; margin-bottom:10px; flex-wrap:wrap; }
    .hdr .sp { flex:1; }
    .pill { font-size:12px; color:#666; background:#f3f4f6; border:1px solid #e5e7eb; padding:4px 8px; border-radius:999px; }
    .monthbar { display:flex; align-items:center; gap:8px; margin:10px 0 8px; }
    .day-list { display:flex; flex-wrap:wrap; gap:6px; }
    .day-btn {
      min-width:28px; text-align:center; padding:4px 6px;
      border:1px solid var(--bd); border-radius:12px; background:#fff; cursor:pointer;
    }
    .day-btn.has { outline:2px solid var(--accent); }
    .note { color:#666; font-size:13px; margin-top:4px; }
    .list { margin-top:10px; }
    .row { padding:8px 0; border-bottom:1px solid #eee; }
    .row a { font-weight:600; }
    .muted { color:#666; font-size:13px; }
  </style>
</head>
<body>
<div class="container">
  <div class="hdr">
    <h1>K-Movie A Archive</h1>
    <div class="sp"></div>
    <a class="btn" href="index.html">홈</a>
    <a class="btn" href="search.html">영화 검색</a>
    <a class="btn" href="people-search.html">배우 검색</a>
    <a class="btn" href="saved.html">저장 목록</a>
  </div>

  <div class="pill" id="rangePill">데이터 범위: 로딩 중…</div>

  <h2 style="margin:12px 0 8px;">월간 타임라인</h2>
  <div class="monthbar">
    <button class="btn" id="prevM">◀ 이전 달</button>
    <div id="ymLabel" style="font-weight:700;"></div>
    <button class="btn" id="nextM">다음 달 ▶</button>
  </div>

  <div class="tl-bar" id="tlBar"></div>
  <div class="tl-panel" id="panel">날짜를 선택하면 해당 날짜의 개봉작을 보여줍니다.</div>
</div>

<script>
const MOVIE_INDEX_URL = 'data/search/movies.json';

// 숫자만 8자리(YYYYMMDD)?
const isYmd8 = (s) => /^\d{8}$/.test(String(s||'').trim());

function ymParts(ym){ return [ym.getFullYear(), ym.getMonth()+1]; }
function pad2(n){ return String(n).padStart(2,'0'); }
function daysInMonth(y,m){ return new Date(y, m, 0).getDate(); } // m: 1~12

let MOVIES = [];        // {movieCd, movieNm, openDt, grade, repNation, genres[], ...}
let YM = new Date();    // 현재 표시 월

function pickValidMovies(src){
  if (!src || !Array.isArray(src.movies)) return [];
  return src.movies.filter(m => isYmd8(m.openDt));
}

function computeRange(arr){
  if (!arr.length) return null;
  let minY = 9999, maxY = 0;
  for (const m of arr){
    const y = parseInt(m.openDt.slice(0,4),10);
    if (isFinite(y)){
      if (y < minY) minY = y;
      if (y > maxY) maxY = y;
    }
  }
  if (minY===9999 || maxY===0) return null;
  return {min:minY, max:maxY};
}

function groupByDay(arr, y, m){ // m: 1~12
  const map = {};
  for (let d=1; d<=daysInMonth(y,m); d++) map[d]=[];
  for (const row of arr){
    if (!isYmd8(row.openDt)) continue;
    const yy = +row.openDt.slice(0,4);
    const mm = +row.openDt.slice(4,6);
    const dd = +row.openDt.slice(6,8);
    if (yy===y && mm===m && map[dd]) map[dd].push(row);
  }
  return map;
}

function renderMonth(){
  const [y, m] = ymParts(YM);
  document.getElementById('ymLabel').textContent = `${y}년 ${pad2(m)}월`;

  const byDay = groupByDay(MOVIES, y, m);
  const bar = document.getElementById('tlBar');
  bar.innerHTML = '';

  const last = daysInMonth(y, m);
  for (let d=1; d<=last; d++){
    const btn = document.createElement('div');
    btn.className = 'tl-day day-btn' + (byDay[d].length ? ' has' : '');
    btn.textContent = d;
    btn.title = byDay[d].length ? `${byDay[d].length}편` : '개봉작 없음';
    btn.onclick = ()=> renderPanel(y,m,d, byDay[d]);
    bar.appendChild(btn);
  }

  // 오늘 날짜가 이 달 안이면 자동 열기, 아니면 1일 열기
  const today = new Date();
  if (today.getFullYear()===y && (today.getMonth()+1)===m){
    renderPanel(y,m,today.getDate(), byDay[today.getDate()]||[]);
  }else{
    renderPanel(y,m,1, byDay[1]||[]);
  }
}

function renderPanel(y,m,d, list){
  const box = document.getElementById('panel');
  const ymd = `${y}-${pad2(m)}-${pad2(d)}`;
  if (!list || list.length===0){
    box.innerHTML = `<div class="muted">해당 날짜(${ymd})에는 등록된 개봉작이 없습니다.</div>`;
    return;
  }
  const rows = list
    .sort((a,b)=> (a.movieNm || '').localeCompare(b.movieNm||'', 'ko'))
    .map(row=>{
      const badge = row.grade ? `[${row.grade}]` : '';
      const rn = row.repNation || '';
      const gens = Array.isArray(row.genres) ? row.genres.join(', ') : '';
      return `
      <div class="row">
        <a href="detail.html?movieCd=${encodeURIComponent(row.movieCd)}">${row.movieNm||'(제목없음)'}</a>
        <div class="muted">${badge} ${rn} ${gens ? '· '+gens : ''}</div>
      </div>`;
    }).join('');
  box.innerHTML = `<div class="note">${ymd} 개봉작 ${list.length}편</div><div class="list">${rows}</div>`;
}

async function main(){
  // 캐시 무력화
  const res = await fetch(`${MOVIE_INDEX_URL}?v=${Date.now()}`);
  if (!res.ok){
    document.getElementById('rangePill').textContent = '데이터 범위: 인덱스 로드 실패';
    return;
  }
  const js = await res.json();
  MOVIES = pickValidMovies(js);

  const rg = computeRange(MOVIES);
  document.getElementById('rangePill').textContent =
    rg ? `데이터 범위: ${rg.min} – ${rg.max} (인덱스 기준)`
       : '데이터 범위: 비어있음 / 인덱스 재생성이 필요할 수 있음';

  renderMonth();

  // 버튼
  document.getElementById('prevM').onclick = ()=>{
    YM.setMonth(YM.getMonth()-1);
    renderMonth();
  };
  document.getElementById('nextM').onclick = ()=>{
    YM.setMonth(YM.getMonth()+1);
    renderMonth();
  };
}

main().catch(e=>{
  console.error(e);
  document.getElementById('rangePill').textContent = '데이터 범위: 오류';
});
</script>
</body>
</html>
