<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>영화 상세 – K-Movie A Archive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    .actor-link { margin-right:6px; }
    .muted { color:#666; }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>영화 상세 정보</h1>
    <div class="spacer"></div>
    <a class="btn" href="index.html">홈</a>
    <a class="btn" href="search.html">영화 검색</a>
    <a class="btn" href="people-search.html">배우 검색</a>
    <a class="btn" href="saved.html">저장 목록</a>
  </div>

  <div id="movieDetail" class="grid"></div>
  <div style="margin-top:12px; display:flex; gap:8px;">
    <button class="btn" onclick="history.back()">🔙 뒤로</button>
    <button class="btn" id="saveBtn">☆ 영화 저장</button>
  </div>
</div>

<script>
/* ================= 공통 ================= */
const params = new URLSearchParams(location.search);
const movieCd = params.get('movieCd') || '';
const box = document.getElementById('movieDetail');
const saveBtn = document.getElementById('saveBtn');

function getSaved(){ return JSON.parse(localStorage.getItem('savedMovies')||'[]'); }
function isSaved(cd){ return getSaved().includes(cd); }
function setSaved(arr){ localStorage.setItem('savedMovies', JSON.stringify(arr)); }
function renderSaveBtn(){ if (!movieCd) return; saveBtn.textContent = isSaved(movieCd) ? '⭐ 저장됨(해제)' : '☆ 영화 저장'; }
saveBtn.addEventListener('click', ()=>{
  if (!movieCd) return;
  let s = getSaved();
  if (isSaved(movieCd)) s = s.filter(x=>x!==movieCd);
  else s.push(movieCd);
  setSaved(s); renderSaveBtn();
});

const fmtNum = n => (n==null || isNaN(n)) ? '' : n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
const INDEX_URL = 'data/search/movies.json';
const YEARS_MANIFEST = 'data/years/_manifest.json'; // 존재하면 사용

async function tryFetchJson(url){
  try{
    const r = await fetch(url, { cache: 'no-store' });
    if (!r.ok) return null;
    return await r.json();
  }catch{ return null; }
}

/* 후보 경로 생성: 인덱스 연도 우선 → 매니페스트 연도들 → 레거시 루트 */
async function guessDetailJsonPaths(cd, indexEntry){
  const paths = new Set();

  // 1) 인덱스에서 연도 추정
  const yCandidate = (indexEntry?.openDt || '').slice(0,4) || indexEntry?.prdtYear || '';
  if (yCandidate) paths.add(`data/movies/${yCandidate}/${cd}.json`);

  // 2) 매니페스트 기반(있을 때만)
  const manifest = await tryFetchJson(YEARS_MANIFEST);
  if (manifest && manifest.years && Array.isArray(manifest.years)){
    manifest.years.forEach(y => paths.add(`data/movies/${y}/${cd}.json`));
  } else {
    // 매니페스트가 없다면 최근 몇 년만 합리적으로 시도
    const nowY = new Date().getFullYear();
    for (let y = nowY+1; y >= 2015; y--){
      paths.add(`data/movies/${y}/${cd}.json`);
    }
  }

  // 3) 레거시 평면 구조(혹시 남아있을 수 있음)
  paths.add(`data/movies/${cd}.json`);

  return Array.from(paths);
}

/* 다양한 구조 허용적으로 파싱 */
function pickMovieInfo(json){
  if (!json) return null;
  if (json.movieInfoResult?.movieInfo) return json.movieInfoResult.movieInfo;     // KOFIC 원본 래핑
  if (json.movieInfo) return json.movieInfo;                                      // 단순 래핑
  // 빌더가 평평하게 저장했을 수 있음
  const keys = ['movieCd','movieNm','openDt','showTm','genres','directors','companys','actors','audits','audiAcc'];
  const ok = keys.some(k => k in json);
  return ok ? json : null;
}

/* 메인 로딩 */
(async function main(){
  if (!movieCd){
    box.textContent = '영화 코드가 없습니다.'; return;
  }

  // 인덱스 읽어서 보조정보 확보(연도·등급·국가·audiAcc 후보)
  const index = await tryFetchJson(INDEX_URL);
  const list = index?.movies || [];
  const idxEntry = list.find(m => m.movieCd === movieCd);

  // 캐시 파일 후보 경로들 만들고 순서대로 조회
  const candidates = await guessDetailJsonPaths(movieCd, idxEntry);
  let raw = null, usedUrl = '';
  for (const u of candidates){
    const j = await tryFetchJson(u);
    const info = pickMovieInfo(j);
    if (info) { raw = info; usedUrl = u; break; }
  }

  if (!raw){
    box.innerHTML = `
      <div style="padding:12px; border:1px solid #f3c2c2; background:#fff5f5; border-radius:8px;">
        캐시된 상세 정보를 찾지 못했습니다.<br/>
        <span class="muted">movieCd=${movieCd}</span>
      </div>`;
    renderSaveBtn();
    return;
  }

  // 필드 정리(두 구조를 모두 지원)
  const title = raw.movieNm || idxEntry?.movieNm || '';
  const prdtYear = raw.prdtYear || idxEntry?.prdtYear || '';
  const openDtRaw = raw.openDt || idxEntry?.openDt || ''; // YYYYMMDD
  const openFmt = openDtRaw ? `${openDtRaw.slice(0,4)}-${openDtRaw.slice(4,6)}-${openDtRaw.slice(6,8)}` : '정보 없음';
  const showTm = raw.showTm ? `${raw.showTm}분` : '';
  const genres = (raw.genres || idxEntry?.genres || []).map(g => g.genreNm || g).join(', ') || '정보 없음';
  const directors = (raw.directors || []).map(d => d.peopleNm).join(', ') || '정보 없음';
  const companies = (raw.companys || []).map(c => c.companyNm).join(', ') || '정보 없음';

  const actorArr = (raw.actors || []).map(a => ({
    cd: a.peopleCd || '',
    nm: a.peopleNm || '',
  }));
  const actorLinksShort = actorArr.slice(0,5).map(a => {
    const href = a.cd
      ? `person.html?peopleCd=${encodeURIComponent(a.cd)}`
      : `person.html?peopleNm=${encodeURIComponent(a.nm)}&movieNm=${encodeURIComponent(title)}`;
    return `<a href="${href}" class="actor-link">${a.nm}</a>`;
  }).join(', ');
  const actorLinksAll = actorArr.map(a => {
    const href = a.cd
      ? `person.html?peopleCd=${encodeURIComponent(a.cd)}`
      : `person.html?peopleNm=${encodeURIComponent(a.nm)}&movieNm=${encodeURIComponent(title)}`;
    return `<a href="${href}" class="actor-link">${a.nm}</a>`;
  }).join(', ');

  // 누적 관객수: 상세(audiAcc) > 인덱스(audiAcc) > 없음
  const audiAcc = (raw.audiAcc != null ? raw.audiAcc : idxEntry?.audiAcc);
  const audiText = (audiAcc != null) ? `${fmtNum(audiAcc)}명` : '집계 데이터 없음';

  box.innerHTML = `
    <div><strong>제목:</strong> ${title} ${prdtYear?`<span class="muted">(${prdtYear})</span>`:''}</div>
    <div><strong>개봉일:</strong> ${openFmt}${showTm?` · <strong>상영시간:</strong> ${showTm}`:''}</div>
    <div><strong>장르:</strong> ${genres}</div>
    <div><strong>감독:</strong> ${directors}</div>
    <div><strong>제작사:</strong> ${companies}</div>
    <div><strong>배우:</strong>
      <span id="actorsShort">${actorLinksShort || '정보 없음'}</span>
      ${actorArr.length>5 ? ` <a href="#" id="actorsMore">더보기</a>
      <span id="actorsAll" style="display:none">${actorLinksAll}</span>` : ''}
    </div>
    <div><strong>관객수(누적):</strong> <span id="audiAccText">${audiText}</span></div>
    <div class="muted">영화코드: ${movieCd} · <span title="사용한 캐시 경로">${usedUrl || '캐시'}</span></div>
  `;

  if (actorArr.length>5){
    document.getElementById('actorsMore').addEventListener('click', (e)=>{
      e.preventDefault();
      document.getElementById('actorsAll').style.display='inline';
      document.getElementById('actorsShort').style.display='none';
      e.target.style.display='none';
    });
  }

  renderSaveBtn();
})();
</script>
</body>
</html>
