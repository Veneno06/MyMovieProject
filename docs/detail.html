<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>ì˜í™” ìƒì„¸ â€“ K-Movie A Archive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ì˜í™” ìƒì„¸ ì •ë³´</h1>
    <div class="spacer"></div>
    <a href="index.html" class="btn">í™ˆ</a>
    <a href="search.html" class="btn">ì˜í™” ê²€ìƒ‰</a>
    <a href="people-search.html" class="btn">ë°°ìš° ê²€ìƒ‰</a>
    <a href="saved.html" class="btn"> ì €ì¥ ëª©ë¡</a>
  </div>

  <div id="movieDetail" class="grid"></div>
  <div style="margin-top:12px; display:flex; gap:8px;">
    <button class="btn" onclick="history.back()">ğŸ”™ ë’¤ë¡œ</button>
    <button class="btn" id="saveBtn">â˜† ì˜í™” ì €ì¥</button>
  </div>
</div>

<script>
const params = new URLSearchParams(location.search);
const movieCd = params.get('movieCd');
const box     = document.getElementById('movieDetail');
const saveBtn = document.getElementById('saveBtn');

function getSaved(){ return JSON.parse(localStorage.getItem('savedMovies')||'[]'); }
function isSaved(cd){ return getSaved().includes(cd); }
function setSaved(arr){ localStorage.setItem('savedMovies', JSON.stringify(arr)); }
function renderSaveBtn(){ if (!movieCd) return; saveBtn.textContent = isSaved(movieCd) ? 'â­ ì €ì¥ë¨(í•´ì œ)' : 'â˜† ì˜í™” ì €ì¥'; }
saveBtn.addEventListener('click', ()=>{
  let s=getSaved();
  if (isSaved(movieCd)) s=s.filter(x=>x!==movieCd);
  else s.push(movieCd);
  setSaved(s); renderSaveBtn();
});

// ìˆ«ì í¬ë§· & ë‚ ì§œ ìœ í‹¸
const fmtNum = n => (n==null || isNaN(n)) ? '' : n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
function parseYMD(ymd){ if(!ymd) return null; const s=String(ymd).replace(/-/g,''); if(s.length!==8) return null; return new Date(+s.slice(0,4), +s.slice(4,6)-1, +s.slice(6,8)); }

// âœ… ì •ì  ìºì‹œì—ì„œ ì˜í™” ìƒì„¸ ì½ê¸°
async function fetchMovieInfoLocal(cd){
  const res = await fetch(`./data/movies/${encodeURIComponent(cd)}.json`);
  if (!res.ok) throw new Error('ì˜í™” ìƒì„¸ ìºì‹œ ì—†ìŒ');
  const js  = await res.json();
  return js.movieInfoResult?.movieInfo;
}

// âœ… (ê°€ëŠ¥í•˜ë©´) ìµœì‹  ì¼ì¼ ë°•ìŠ¤ì˜¤í”¼ìŠ¤ì—ì„œ ëˆ„ì  ê´€ê°ìˆ˜ ê°€ì ¸ì˜¤ê¸°
async function fetchAudienceAccFromLatest(cd){
  try{
    const meta = await fetch('./data/latest.json?v=' + Date.now()).then(r=>r.json());
    const day  = await fetch(meta.url + '?v=' + Date.now()).then(r=>r.json());
    const list = day?.boxOfficeResult?.dailyBoxOfficeList || [];
    const f = list.find(x => x.movieCd === cd);
    if (f?.audiAcc){
      const acc = parseInt(String(f.audiAcc).replace(/,/g,''),10);
      if (!isNaN(acc)) return acc;
    }
  }catch(e){ /* ignore */ }
  return null; // ì—†ìœ¼ë©´ í‘œê¸° ìƒëµ
}

async function load(){
  if (!movieCd){ box.textContent='ì˜í™” ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.'; return; }
  try{
    const info = await fetchMovieInfoLocal(movieCd);
    if (!info){ box.textContent='ì˜í™” ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'; return; }

    const title     = info.movieNm;
    const prdtYear  = info.prdtYear || '';
    const openDt    = info.openDt || 'ì •ë³´ ì—†ìŒ';
    const showTm    = info.showTm ? `${info.showTm}ë¶„` : '';
    const genres    =(info.genres||[]).map(g=>g.genreNm).join(', ')||'ì •ë³´ ì—†ìŒ';
    const directors =(info.directors||[]).map(d=>d.peopleNm).join(', ')||'ì •ë³´ ì—†ìŒ';
    const companies =(info.companys||[]).map(c=>c.companyNm).join(', ')||'ì •ë³´ ì—†ìŒ';

    // ë°°ìš° ë§í¬(ì›ë³¸ ë¡œì§ ìœ ì§€)
    const actorLinksShort = (info.actors || []).slice(0, 5).map(a => {
      const cd = a.peopleCd;
      const nm = a.peopleNm || '';
      const href = cd
        ? `person.html?peopleCd=${encodeURIComponent(cd)}`
        : `person.html?peopleNm=${encodeURIComponent(nm)}&movieNm=${encodeURIComponent(title)}`;
      return `<a href="${href}" class="actor-link">${nm}</a>`;
    }).join(', ');

    const actorLinksAll = (info.actors || []).map(a => {
      const cd = a.peopleCd;
      const nm = a.peopleNm || '';
      const href = cd
        ? `person.html?peopleCd=${encodeURIComponent(cd)}`
        : `person.html?peopleNm=${encodeURIComponent(nm)}&movieNm=${encodeURIComponent(title)}`;
      return `<a href="${href}" class="actor-link">${nm}</a>`;
    }).join(', ');

    box.innerHTML=`
      <div><strong>ì œëª©:</strong> ${title} ${prdtYear?`<span class="muted">(${prdtYear})</span>`:''}</div>
      <div><strong>ê°œë´‰ì¼:</strong> ${openDt}${showTm?` Â· <strong>ìƒì˜ì‹œê°„:</strong> ${showTm}`:''}</div>
      <div><strong>ì¥ë¥´:</strong> ${genres}</div>
      <div><strong>ê°ë…:</strong> ${directors}</div>
      <div><strong>ì œì‘ì‚¬:</strong> ${companies}</div>
      <div><strong>ë°°ìš°:</strong> 
        <span id="actorsShort">${actorLinksShort}</span>
        ${(info.actors||[]).length>5 ? ` <a href="#" id="actorsMore">ë”ë³´ê¸°</a>
        <span id="actorsAll" style="display:none">${actorLinksAll}</span>` : ''}
      </div>

      <!-- ê´€ê°ìˆ˜ ë¼ì¸ -->
      <div><strong>ê´€ê°ìˆ˜(ëˆ„ì ):</strong> <span id="audiAccText">ì¡°íšŒ ì¤‘â€¦</span></div>

      <div class="muted">ì˜í™”ì½”ë“œ: ${movieCd}</div>
    `;

    if ((info.actors||[]).length>5){
      document.getElementById('actorsMore').addEventListener('click', (e)=>{
        e.preventDefault();
        document.getElementById('actorsAll').style.display='inline';
        document.getElementById('actorsShort').style.display='none';
        e.target.style.display='none';
      });
    }

    renderSaveBtn();

    // ëˆ„ì  ê´€ê°ìˆ˜(ìˆì„ ë•Œë§Œ)
    const acc = await fetchAudienceAccFromLatest(movieCd);
    document.getElementById('audiAccText').textContent =
      (acc!=null) ? `${fmtNum(acc)}ëª…` : 'ì§‘ê³„ ë°ì´í„° ì—†ìŒ';

  }catch(e){ console.error(e); box.textContent='ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'; }
}
load();
</script>
</body>
</html>
