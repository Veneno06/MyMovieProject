<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ì˜í™” ìƒì„¸ â€“ K-Movie A Archive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    .actor-link { margin-right:6px; }
    .muted { color:#666; }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ì˜í™” ìƒì„¸ ì •ë³´</h1>
    <div class="spacer"></div>
    <a class="btn" href="index.html">í™ˆ</a>
    <a class="btn" href="search.html">ì˜í™” ê²€ìƒ‰</a>
    <a class="btn" href="people-search.html">ë°°ìš° ê²€ìƒ‰</a>
    <a class="btn" href="saved.html">ì €ì¥ ëª©ë¡</a>
  </div>

  <div id="movieDetail" class="grid"></div>
  <div style="margin-top:12px; display:flex; gap:8px;">
    <button class="btn" onclick="history.back()">ğŸ”™ ë’¤ë¡œ</button>
    <button class="btn" id="saveBtn">â˜† ì˜í™” ì €ì¥</button>
  </div>
</div>

<script>
/* ================= ê³µí†µ ================= */
const params = new URLSearchParams(location.search);
const movieCd = params.get('movieCd') || '';
const box = document.getElementById('movieDetail');
const saveBtn = document.getElementById('saveBtn');

function getSaved(){ return JSON.parse(localStorage.getItem('savedMovies')||'[]'); }
function isSaved(cd){ return getSaved().includes(cd); }
function setSaved(arr){ localStorage.setItem('savedMovies', JSON.stringify(arr)); }
function renderSaveBtn(){ if (!movieCd) return; saveBtn.textContent = isSaved(movieCd) ? 'â­ ì €ì¥ë¨(í•´ì œ)' : 'â˜† ì˜í™” ì €ì¥'; }
saveBtn.addEventListener('click', ()=>{
  if (!movieCd) return;
  let s = getSaved();
  if (isSaved(movieCd)) s = s.filter(x=>x!==movieCd);
  else s.push(movieCd);
  setSaved(s); renderSaveBtn();
});

const fmtNum = n => (n==null || isNaN(n)) ? '' : n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
const INDEX_URL = 'data/search/movies.json';
const YEARS_MANIFEST = 'data/years/_manifest.json'; // ì¡´ì¬í•˜ë©´ ì‚¬ìš©

async function tryFetchJson(url){
  try{
    const r = await fetch(url, { cache: 'no-store' });
    if (!r.ok) return null;
    return await r.json();
  }catch{ return null; }
}

/* í›„ë³´ ê²½ë¡œ ìƒì„±: ì¸ë±ìŠ¤ ì—°ë„ ìš°ì„  â†’ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—°ë„ë“¤ â†’ ë ˆê±°ì‹œ ë£¨íŠ¸ */
async function guessDetailJsonPaths(cd, indexEntry){
  const paths = new Set();

  // 1) ì¸ë±ìŠ¤ì—ì„œ ì—°ë„ ì¶”ì •
  const yCandidate = (indexEntry?.openDt || '').slice(0,4) || indexEntry?.prdtYear || '';
  if (yCandidate) paths.add(`data/movies/${yCandidate}/${cd}.json`);

  // 2) ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ê¸°ë°˜(ìˆì„ ë•Œë§Œ)
  const manifest = await tryFetchJson(YEARS_MANIFEST);
  if (manifest && manifest.years && Array.isArray(manifest.years)){
    manifest.years.forEach(y => paths.add(`data/movies/${y}/${cd}.json`));
  } else {
    // ë§¤ë‹ˆí˜ìŠ¤íŠ¸ê°€ ì—†ë‹¤ë©´ ìµœê·¼ ëª‡ ë…„ë§Œ í•©ë¦¬ì ìœ¼ë¡œ ì‹œë„
    const nowY = new Date().getFullYear();
    for (let y = nowY+1; y >= 2015; y--){
      paths.add(`data/movies/${y}/${cd}.json`);
    }
  }

  // 3) ë ˆê±°ì‹œ í‰ë©´ êµ¬ì¡°(í˜¹ì‹œ ë‚¨ì•„ìˆì„ ìˆ˜ ìˆìŒ)
  paths.add(`data/movies/${cd}.json`);

  return Array.from(paths);
}

/* ë‹¤ì–‘í•œ êµ¬ì¡° í—ˆìš©ì ìœ¼ë¡œ íŒŒì‹± */
function pickMovieInfo(json){
  if (!json) return null;
  if (json.movieInfoResult?.movieInfo) return json.movieInfoResult.movieInfo;     // KOFIC ì›ë³¸ ë˜í•‘
  if (json.movieInfo) return json.movieInfo;                                      // ë‹¨ìˆœ ë˜í•‘
  // ë¹Œë”ê°€ í‰í‰í•˜ê²Œ ì €ì¥í–ˆì„ ìˆ˜ ìˆìŒ
  const keys = ['movieCd','movieNm','openDt','showTm','genres','directors','companys','actors','audits','audiAcc'];
  const ok = keys.some(k => k in json);
  return ok ? json : null;
}

/* ë©”ì¸ ë¡œë”© */
(async function main(){
  if (!movieCd){
    box.textContent = 'ì˜í™” ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.'; return;
  }

  // ì¸ë±ìŠ¤ ì½ì–´ì„œ ë³´ì¡°ì •ë³´ í™•ë³´(ì—°ë„Â·ë“±ê¸‰Â·êµ­ê°€Â·audiAcc í›„ë³´)
  const index = await tryFetchJson(INDEX_URL);
  const list = index?.movies || [];
  const idxEntry = list.find(m => m.movieCd === movieCd);

  // ìºì‹œ íŒŒì¼ í›„ë³´ ê²½ë¡œë“¤ ë§Œë“¤ê³  ìˆœì„œëŒ€ë¡œ ì¡°íšŒ
  const candidates = await guessDetailJsonPaths(movieCd, idxEntry);
  let raw = null, usedUrl = '';
  for (const u of candidates){
    const j = await tryFetchJson(u);
    const info = pickMovieInfo(j);
    if (info) { raw = info; usedUrl = u; break; }
  }

  if (!raw){
    box.innerHTML = `
      <div style="padding:12px; border:1px solid #f3c2c2; background:#fff5f5; border-radius:8px;">
        ìºì‹œëœ ìƒì„¸ ì •ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br/>
        <span class="muted">movieCd=${movieCd}</span>
      </div>`;
    renderSaveBtn();
    return;
  }

  // í•„ë“œ ì •ë¦¬(ë‘ êµ¬ì¡°ë¥¼ ëª¨ë‘ ì§€ì›)
  const title = raw.movieNm || idxEntry?.movieNm || '';
  const prdtYear = raw.prdtYear || idxEntry?.prdtYear || '';
  const openDtRaw = raw.openDt || idxEntry?.openDt || ''; // YYYYMMDD
  const openFmt = openDtRaw ? `${openDtRaw.slice(0,4)}-${openDtRaw.slice(4,6)}-${openDtRaw.slice(6,8)}` : 'ì •ë³´ ì—†ìŒ';
  const showTm = raw.showTm ? `${raw.showTm}ë¶„` : '';
  const genres = (raw.genres || idxEntry?.genres || []).map(g => g.genreNm || g).join(', ') || 'ì •ë³´ ì—†ìŒ';
  const directors = (raw.directors || []).map(d => d.peopleNm).join(', ') || 'ì •ë³´ ì—†ìŒ';
  const companies = (raw.companys || []).map(c => c.companyNm).join(', ') || 'ì •ë³´ ì—†ìŒ';

  const actorArr = (raw.actors || []).map(a => ({
    cd: a.peopleCd || '',
    nm: a.peopleNm || '',
  }));
  const actorLinksShort = actorArr.slice(0,5).map(a => {
    const href = a.cd
      ? `person.html?peopleCd=${encodeURIComponent(a.cd)}`
      : `person.html?peopleNm=${encodeURIComponent(a.nm)}&movieNm=${encodeURIComponent(title)}`;
    return `<a href="${href}" class="actor-link">${a.nm}</a>`;
  }).join(', ');
  const actorLinksAll = actorArr.map(a => {
    const href = a.cd
      ? `person.html?peopleCd=${encodeURIComponent(a.cd)}`
      : `person.html?peopleNm=${encodeURIComponent(a.nm)}&movieNm=${encodeURIComponent(title)}`;
    return `<a href="${href}" class="actor-link">${a.nm}</a>`;
  }).join(', ');

  // ëˆ„ì  ê´€ê°ìˆ˜: ìƒì„¸(audiAcc) > ì¸ë±ìŠ¤(audiAcc) > ì—†ìŒ
  const audiAcc = (raw.audiAcc != null ? raw.audiAcc : idxEntry?.audiAcc);
  const audiText = (audiAcc != null) ? `${fmtNum(audiAcc)}ëª…` : 'ì§‘ê³„ ë°ì´í„° ì—†ìŒ';

  box.innerHTML = `
    <div><strong>ì œëª©:</strong> ${title} ${prdtYear?`<span class="muted">(${prdtYear})</span>`:''}</div>
    <div><strong>ê°œë´‰ì¼:</strong> ${openFmt}${showTm?` Â· <strong>ìƒì˜ì‹œê°„:</strong> ${showTm}`:''}</div>
    <div><strong>ì¥ë¥´:</strong> ${genres}</div>
    <div><strong>ê°ë…:</strong> ${directors}</div>
    <div><strong>ì œì‘ì‚¬:</strong> ${companies}</div>
    <div><strong>ë°°ìš°:</strong>
      <span id="actorsShort">${actorLinksShort || 'ì •ë³´ ì—†ìŒ'}</span>
      ${actorArr.length>5 ? ` <a href="#" id="actorsMore">ë”ë³´ê¸°</a>
      <span id="actorsAll" style="display:none">${actorLinksAll}</span>` : ''}
    </div>
    <div><strong>ê´€ê°ìˆ˜(ëˆ„ì ):</strong> <span id="audiAccText">${audiText}</span></div>
    <div class="muted">ì˜í™”ì½”ë“œ: ${movieCd} Â· <span title="ì‚¬ìš©í•œ ìºì‹œ ê²½ë¡œ">${usedUrl || 'ìºì‹œ'}</span></div>
  `;

  if (actorArr.length>5){
    document.getElementById('actorsMore').addEventListener('click', (e)=>{
      e.preventDefault();
      document.getElementById('actorsAll').style.display='inline';
      document.getElementById('actorsShort').style.display='none';
      e.target.style.display='none';
    });
  }

  renderSaveBtn();
})();
</script>
</body>
</html>
