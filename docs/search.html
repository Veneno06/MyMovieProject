<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>영화 검색 – K-Movie A Archive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="assets/style.css">
  <style>
    .muted { color:#666; }
    .badge { color:#2f6f2f; margin-left:6px; }
    .row { margin:10px 0; }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>영화 검색(기간)</h1>
    <div class="spacer"></div>
    <a href="index.html" class="btn">홈</a>
    <a href="saved.html" class="btn"> 저장 목록</a>
    <a href="people-search.html" class="btn">배우 검색</a>
  </div>

  <div id="searchControls">
    <div class="row">
      <label>시작일: <input type="date" id="startDate"></label>
    </div>
    <div class="row">
      <label>종료일: <input type="date" id="endDate"></label>
    </div>

    <div class="row">
      <span>등급:</span>
      <label><input type="checkbox" value="전체관람가" checked> 전체관람가</label>
      <label><input type="checkbox" value="12세이상관람가" checked> 12세 이상 관람가</label>
      <label><input type="checkbox" value="15세이상관람가" checked> 15세 이상 관람가</label>
      <label><input type="checkbox" value="청소년관람불가"> 청소년 관람불가</label>
    </div>

    <div class="row">
      <span>국가:</span>
      <label><input type="radio" name="nation" value="all" checked> 모두</label>
      <label><input type="radio" name="nation" value="kr"> 국내</label>
      <label><input type="radio" name="nation" value="fr"> 국외</label>
    </div>

    <button id="searchBtn" class="btn">검색</button>
  </div>

  <div id="results" style="margin-top:16px;"></div>
</div>

<script>
const $ = s => document.querySelector(s);
const pad = n => String(n).padStart(2,'0');
const yyyymmdd = d => `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}`;

function initDates() {
  const now=new Date();
  const first=new Date(now.getFullYear(), now.getMonth(), 1);
  const last=new Date(now.getFullYear(), now.getMonth()+1, 0);
  $('#startDate').value = `${first.getFullYear()}-${pad(first.getMonth()+1)}-${pad(first.getDate())}`;
  $('#endDate').value   = `${last.getFullYear()}-${pad(last.getMonth()+1)}-${pad(last.getDate())}`;
}
initDates();

async function loadMoviesIndex(){
  const res = await fetch('./data/search/movies.json', {cache:'no-store'});
  if (!res.ok) throw new Error('movies index load failed');
  return res.json();
}

function getSelectedGrades(){
  return Array.from(document.querySelectorAll('input[type=checkbox]:checked')).map(el=>el.value);
}
function getNationFilter(){
  const v = document.querySelector('input[name="nation"]:checked').value;
  if (v === 'kr') return 'kr';
  if (v === 'fr') return 'fr';
  return 'all';
}

$('#searchBtn').addEventListener('click', async ()=>{
  const resultDiv = $('#results');
  resultDiv.textContent = '검색 중…';

  const s = $('#startDate').value.replace(/\D/g,'');
  const e = $('#endDate').value.replace(/\D/g,'');
  const start = Math.min(s,e), end = Math.max(s,e);

  try{
    const idx = await loadMoviesIndex();
    let list = idx.filter(m => {
      const d = (m.openDt||'');
      if (!d) return false;
      if (d < start || d > end) return false;
      return true;
    });

    // 국가 필터
    const nf = getNationFilter();
    if (nf === 'kr') list = list.filter(m => m.isKR === true);
    if (nf === 'fr') list = list.filter(m => m.isKR === false);

    // 등급 필터
    const grades = getSelectedGrades();
    if (grades.length) {
      list = list.filter(m => !m.grade || grades.some(g => (m.grade||'').includes(g)));
    }

    // 최신 개봉일 순
    list.sort((a,b) => (b.openDt||'') < (a.openDt||'') ? -1 : 1);

    resultDiv.innerHTML = '';
    if (!list.length){
      resultDiv.innerHTML = `<div class="muted">조건에 맞는 결과가 없습니다.</div>`;
      return;
    }
    for (const m of list){
      const o = m.openDt ? `${m.openDt.slice(0,4)}.${m.openDt.slice(4,6)}.${m.openDt.slice(6,8)}` : '';
      const div = document.createElement('div');
      div.style.marginBottom='10px';
      div.innerHTML =
        `<a href="detail.html?movieCd=${m.movieCd}" style="font-size:18px;">${m.movieNm}</a>
         <span class="muted"> (${o})</span>
         ${m.grade ? `<span class="badge">[${m.grade}]</span>` : ''}`;
      resultDiv.appendChild(div);
    }
  }catch(e){
    console.error(e);
    resultDiv.innerHTML = `<div class="muted">인덱스 로드 실패</div>`;
  }
});
</script>
</body>
</html>
