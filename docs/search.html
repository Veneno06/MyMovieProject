<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <title>영화 검색(기간)</title>
  <link rel="stylesheet" href="assets/style.css"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{max-width:900px;margin:2rem auto;padding:0 1rem;}
    .muted{color:#666;font-size:0.9rem}
    .badge{display:inline-block;padding:.2rem .45rem;border:1px solid #ccc;border-radius:.5rem;margin-left:.3rem;font-size:.85rem;color:#555}
    .btn{padding:.4rem .7rem;border:1px solid #bbb;border-radius:.4rem;background:#fff}
    .list a{color:#1565c0;text-decoration:none}
    .list small{color:#777}
    .toolbar{background:#f7f7f7;border:1px solid #e6e6e6;padding:.6rem .8rem;border-radius:.5rem;margin:.75rem 0 1rem}
  </style>
</head>
<body>
  <h1>영화 검색(기간)</h1>

  <div class="toolbar">
    <div class="muted">데이터 범위: <span id="rangeText">로딩 중…</span> (인덱스 기준)</div>
    <div style="margin-top:.4rem">
      시작일: <input type="date" id="from"> &nbsp;
      종료일: <input type="date" id="to"> &nbsp;
      등급:
      <label><input type="checkbox" class="gr" value="전체관람가" checked> 전체관람가</label>
      <label><input type="checkbox" class="gr" value="12세이상관람가" checked> 12세 이상 관람가</label>
      <label><input type="checkbox" class="gr" value="15세이상관람가" checked> 15세 이상 관람가</label>
      <label><input type="checkbox" class="gr" value="청소년관람불가"> 청소년 관람불가</label>
      <br>
      국가:
      <label><input type="radio" name="nat" value="all" checked> 모두</label>
      <label><input type="radio" name="nat" value="K"> 국내 영화</label>
      <label><input type="radio" name="nat" value="F"> 해외 영화</label>
      &nbsp; <button id="go" class="btn">검색</button>
    </div>
  </div>

  <div id="out" class="list"></div>

  <p class="muted">문제가 있나요? 인덱스를 갱신해 주세요 (Actions → Build Search Indexes only).</p>

<script>
const MOV_URL = "data/search/movies.json";

function ymd(s){ // 'YYYYMMDD' -> 'YYYY-MM-DD'
  if(!s || s.length!==8) return "";
  return s.slice(0,4)+"-"+s.slice(4,6)+"-"+s.slice(6,8);
}
function ymdRaw(s){ // 'YYYY-MM-DD' -> 'YYYYMMDD'
  if(!s || s.length!==10) return "";
  return s.replace(/-/g,"");
}
function within(d, a, b){ // 문자열 'YYYYMMDD'
  if(!d) return false;
  if(a && d < a) return false;
  if(b && d > b) return false;
  return true;
}

async function load(){
  const res = await fetch(MOV_URL, {cache:"no-store"});
  const j = await res.json();
  window.__MOV = j.movies || [];
  const first = (j.movies||[]).find(m=>m.openDt && m.openDt.length===8);
  const last  = [...(j.movies||[])].reverse().find(m=>m.openDt && m.openDt.length===8);
  const rText = (first && last) ? `${ymd(first.openDt)} ~ ${ymd(last.openDt)}` : "알 수 없음";
  document.querySelector("#rangeText").textContent = rText;

  // 기본 날짜: 올해 1/1 ~ 오늘
  const today = new Date();
  const y = today.getFullYear(), m = (""+(today.getMonth()+1)).padStart(2,'0'), d = (""+today.getDate()).padStart(2,'0');
  document.querySelector("#from").value = `${y}-01-01`;
  document.querySelector("#to").value = `${y}-${m}-${d}`;
}

function run(){
  const from = ymdRaw(document.querySelector("#from").value);
  const to   = ymdRaw(document.querySelector("#to").value);
  const grs = Array.from(document.querySelectorAll(".gr:checked")).map(x=>x.value);
  const nat = (document.querySelector('input[name="nat"]:checked')||{}).value || "all";

  const rows = (window.__MOV||[]).filter(m=>{
    // 날짜
    if(!within(m.openDt || "", from, to)) return false;
    // 등급
    const g = m.grade || "";
    if(grs.length && !grs.includes(g)) return false;
    // 국가
    if(nat !== "all"){
      if ((m.repNation || "") !== nat) return false;   // "K" / "F"
    }
    return true;
  });

  const out = document.querySelector("#out");
  if(!rows.length){
    out.innerHTML = `<p class="muted">조건에 맞는 결과가 없습니다. (데이터 범위: ${document.querySelector("#rangeText").textContent} / 선택: ${document.querySelector("#from").value}~${document.querySelector("#to").value})</p>`;
    return;
  }

  out.innerHTML = rows.map(m=>{
    const dt = m.openDt ? `(${ymd(m.openDt)})` : ``;
    const g  = m.grade ? ` <span class="badge">[${m.grade}]</span>` : "";
    const link = `detail.html?movieCd=${encodeURIComponent(m.movieCd)}`;
    return `<p><a href="${link}">${m.movieNm}</a> ${dt}${g}</p>`;
  }).join("");
}

document.querySelector("#go").addEventListener("click", run);
load().then(run);
</script>
</body>
</html>
