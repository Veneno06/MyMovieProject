<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>영화 검색 – K-Movie A Archive</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="assets/style.css">
  <style>
    #searchControls { display:block; }
    .row { display:block; margin:10px 0; }
    .row > label:first-child { font-weight:600; margin-right:8px; }
    .row input[type="date"], .row input[type="text"] { min-width:180px; }
    .hint { color:#777; font-size:12px; margin-left:6px; }
    #gradeFilters, #nationFilters { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .badge { color:#2f6f2f; margin-left:6px; }
    .muted { color:#666; }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>영화 검색(기간)</h1>
    <div class="spacer"></div>
    <a href="index.html" class="btn">홈</a>
    <a href="saved.html" class="btn"> 저장 목록</a>
    <a href="people-search.html" class="btn">배우 검색</a>
  </div>

  <div id="searchControls">
    <div class="row">
      <label for="startDate">시작일:</label>
      <input type="date" id="startDate" placeholder="YYYY-MM-DD">
      <small class="hint">입력 또는 달력에서 선택</small>
    </div>
    <div class="row">
      <label for="endDate">종료일:</label>
      <input type="date" id="endDate" placeholder="YYYY-MM-DD">
    </div>

    <div id="gradeFilters" class="row">
      <span>등급:</span>
      <label><input type="checkbox" value="전체관람가" checked> 전체관람가</label>
      <label><input type="checkbox" value="12세이상관람가" checked> 12세 이상 관람가</label>
      <label><input type="checkbox" value="15세이상관람가" checked> 15세 이상 관람가</label>
      <label><input type="checkbox" value="청소년관람불가"> 청소년 관람불가</label>
    </div>

    <div id="nationFilters" class="row">
      <span>국가:</span>
      <label><input type="checkbox" id="nationAll" checked> 모두</label>
      <label><input type="checkbox" id="nationKR"> 국내 영화</label>
      <label><input type="checkbox" id="nationFR"> 국외 영화</label>
    </div>

    <button id="searchBtn" class="btn">검색</button>
  </div>

  <div id="results" style="margin-top:16px;"></div>
</div>

<script>
/* ===== 경로 & 캐시버스터 ===== */
const MOVIE_INDEX_URL  = 'data/search/movies.json?v=' + Date.now();

/* ===== 유틸 ===== */
const $ = s => document.querySelector(s);
const pad = (n,w=2)=>String(n).padStart(w,'0');
function isValidISODate(s){ if(!/^\d{4}-\d{2}-\d{2}$/.test(s)) return false; const d=new Date(s); return !isNaN(d.getTime()); }
function normalizeDate(el){ const digits=(el.value||'').replace(/\D/g,'').slice(0,8); if(digits.length<8) return null; const y=+digits.slice(0,4), m=+digits.slice(4,6), d=+digits.slice(6,8); const dt=new Date(y,m-1,d); const v=`${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`; el.value=v; return v; }
function applyNationFilter(list){
  const all=$('#nationAll'), kr=$('#nationKR'), fr=$('#nationFR');
  if(all.checked) return list;
  if(kr.checked)  return list.filter(m => (m.nation||m.nationAlt||'').includes('한국'));
  if(fr.checked)  return list.filter(m => !(m.nation||m.nationAlt||'').includes('한국'));
  return list;
}
;(()=>{ // 날짜 초기값: 이번달 1일~말일
  const s=$('#startDate'), e=$('#endDate');
  const now=new Date(), first=new Date(now.getFullYear(), now.getMonth(), 1), last=new Date(now.getFullYear(), now.getMonth()+1, 0);
  const fmt=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  s.value=fmt(first); e.value=fmt(last);
  ['blur','change'].forEach(ev=>{ s.addEventListener(ev,()=>normalizeDate(s)); e.addEventListener(ev,()=>normalizeDate(e)); });
})();

/* ===== 인덱스 로드 ===== */
async function loadIndex(){
  const res = await fetch(MOVIE_INDEX_URL);
  if(!res.ok) throw new Error('index http '+res.status);
  const j = await res.json();
  // by_date가 있으면 그대로, 없으면 movies를 날짜로 묶기
  const byDate = j.by_date || j.byDate;
  if (byDate && typeof byDate==='object') return byDate;
  const list = j.movies || [];
  const m = {};
  for (const it of list) {
    const d = String(it.openDt||'').replace(/\D/g,''); if(!d) continue;
    (m[d] ||= []).push(it);
  }
  return m;
}

function getSelectedGrades(){
  return Array.from(document.querySelectorAll('#gradeFilters input[type="checkbox"]:checked')).map(el=>el.value);
}

/* ===== 검색 ===== */
$('#searchBtn').addEventListener('click', async ()=>{
  const out = $('#results'); out.textContent = '인덱스 불러오는 중…';
  const sEl=$('#startDate'), eEl=$('#endDate');
  const s=normalizeDate(sEl)||sEl.value, e=normalizeDate(eEl)||eEl.value;
  if(!isValidISODate(s) || !isValidISODate(e)){ alert('YYYY-MM-DD 형식으로 입력해주세요.'); return; }

  try{
    const map = await loadIndex(); // {"YYYYMMDD":[...]}
    const sYMD = s.replace(/\D/g,''), eYMD = e.replace(/\D/g,'');
    const days = [];
    for (let d = new Date(s); d <= new Date(e); d.setDate(d.getDate()+1)) {
      days.push(String(d.getFullYear())+pad(d.getMonth()+1)+pad(d.getDate()));
    }
    // 모으기
    let acc = [];
    for (const key of days) acc = acc.concat(map[key]||[]);
    // 국가, 등급 필터(등급은 인덱스에 들어있으면 표시/필터)
    acc = applyNationFilter(acc);
    const grades = getSelectedGrades();
    if (grades.length) acc = acc.filter(m => (m.grade||'') && grades.some(g=>m.grade.includes(g)));
    // 정렬
    acc.sort((a,b)=> (+(b.openDt||0) - +(a.openDt||0)));
    // 렌더
    if(!acc.length){ out.innerHTML = `<div class="muted">조건에 맞는 결과가 없습니다.</div>`; return; }
    out.innerHTML = '';
    for (const m of acc) {
      const open = String(m.openDt||'').replace(/\D/g,'');
      const openFmt = open ? `${open.slice(0,4)}.${open.slice(4,6)}.${open.slice(6,8)}` : '';
      const div = document.createElement('div');
      div.style.marginBottom='10px';
      div.innerHTML =
        `<a href="detail.html?movieCd=${encodeURIComponent(m.movieCd)}" style="font-size:18px;">${m.movieNm}</a>
         <span class="muted"> (${openFmt})</span>
         ${m.grade ? `<span class="badge">[${m.grade}]</span>` : ''}`;
      out.appendChild(div);
    }
  }catch(e){
    console.error(e);
    out.innerHTML = `<div style="padding:10px;background:#fdecea;border:1px solid #f5c6cb;">
      인덱스 로드 실패 — <a href="data/search/movies.json" target="_blank" rel="noopener">movies.json</a>이 열리는지 먼저 확인해주세요.
    </div>`;
  }
});

/* 국가 체크박스 상호배타 로직 */
(function nationInit(){
  const all=$('#nationAll'), kr=$('#nationKR'), fr=$('#nationFR');
  function sync(){
    if(this===all){ all.checked=true; kr.checked=false; fr.checked=false; return; }
    all.checked=false;
    if(kr.checked && fr.checked){ all.checked=true; kr.checked=false; fr.checked=false; }
    if(!kr.checked && !fr.checked) all.checked=true;
  }
  [all,kr,fr].forEach(cb=>cb.addEventListener('change', sync));
})();
</script>
</body>
</html>
