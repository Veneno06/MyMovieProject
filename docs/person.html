<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>배우 프로필 – K-Movie A Archive (캐시)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="assets/style.css" />
<style>
  body { max-width: 900px; margin: 24px auto; padding: 0 12px; }
  .film { padding:8px 0; border-bottom:1px solid #eee; }
  .small { color:#666; font-size:13px; }
  .muted { color:#777; }
</style>

<!-- 차트는 데이터가 있을 때만 그립니다 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="header">
    <h1>K-Movie A Archive</h1>
    <div class="spacer"></div>
    <a href="index.html" class="btn">홈</a>
    <a href="search.html" class="btn">영화 검색</a>
    <a href="people-search.html" class="btn">배우 검색</a>
    <a href="saved.html" class="btn"> 저장 목록</a>
  </div>

  <h1 id="personName">배우 프로필</h1>
  <p id="personMeta" class="small"></p>

  <h3>출연작 (최신 개봉일 순)</h3>
  <div id="filmList">불러오는 중…</div>

  <p style="margin-top:12px;">
    <button class="btn" onclick="history.back()">← 뒤로가기</button>
  </p>

  <!-- 차트 영역 (데이터 없으면 감춤) -->
  <div id="chartWrap" style="margin-top:40px; display:none;">
    <h3>개봉 시기별 관객수 추이</h3>
    <div style="position:relative; height:400px;">
      <canvas id="audiChart"></canvas>
    </div>
    <br>
    <p id="chartNote" class="small" style="margin-top:8px; color:#666;">
      캐시에 누적 관객수 데이터가 없는 경우 차트는 표시되지 않습니다.
    </p>
  </div>

<script>
/* ================= 유틸 ================= */
const $ = sel => document.querySelector(sel);
const pad = (n)=> String(n).padStart(2,'0');
const fmtDateYMD = (ymd) => {
  if(!ymd) return '';
  const s = String(ymd).replace(/\D/g,'');
  if (s.length !== 8) return '';
  return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
};
const norm = s => (s||'').toLowerCase().replace(/\s+/g,'').trim();

/* ================= 입력 파라미터 ================= */
const params = new URLSearchParams(location.search);
const paramPeopleCd = params.get('peopleCd') || '';
const paramPeopleNm = params.get('peopleNm') || '';

/* ================= 캐시 경로 ================= */
const PEOPLE_INDEX_URL = './data/search/people.json';
const MOVIES_INDEX_URL = './data/search/movies.json';

let PEOPLE = [];   // [{peopleCd, peopleNm, repRoleNm, filmoNames}, ...]
let MOVIES = [];   // [{movieCd, movieNm, openDt, ...}, ...]

/* ================= 캐시 로드 ================= */
async function loadIndex(url){
  const res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) throw new Error('인덱스 로드 실패: ' + url);
  const js = await res.json();
  // 배열 또는 {people:[..]} / {movies:[..]} 형태 방어
  if (Array.isArray(js)) return js;
  if (js.people) return js.people;
  if (js.movies) return js.movies;
  return [];
}

/* ================= 인물 해석 ================= */
function findPersonByCd(cd){
  return PEOPLE.find(p => p.peopleCd === cd);
}
function findPersonByName(nm){
  const target = norm(nm);
  if (!target) return null;
  // 완전일치 우선 → 포함 검색
  return PEOPLE.find(p => norm(p.peopleNm) === target) ||
         PEOPLE.find(p => norm(p.peopleNm).includes(target)) ||
         null;
}

/* ================= 필모 → 영화 매칭 ================= */
/** filmoNames 문자열에서 작품명 후보 배열을 뽑는다. */
function parseFilmoNames(filmoNames){
  if (!filmoNames) return [];
  return filmoNames
    .split('|')
    .map(s => s.trim())
    .filter(Boolean)
    .map(s => {
      // "작품명(YYYY)" 형태가 섞여 있을 수 있음 → 괄호 앞 부분만
      const m = s.match(/^(.*?)(\(\d{4}\))?$/);
      return (m ? m[1] : s).trim();
    });
}

/** 영화 인덱스에서 제목으로 대략 매칭 (완전일치 > 포함) */
function matchMoviesByTitleCandidates(titles){
  const set = new Map(); // movieCd → movie
  const movieByName = new Map();
  for (const m of MOVIES){
    const key = norm(m.movieNm);
    if (key) movieByName.set(key, m);
  }

  // 1) 완전일치
  for (const t of titles){
    const hit = movieByName.get(norm(t));
    if (hit) set.set(hit.movieCd, hit);
  }
  // 2) 포함 검색(한글 공백/대소문자 무시)
  for (const t of titles){
    const key = norm(t);
    for (const m of MOVIES){
      if (set.has(m.movieCd)) continue;
      if (norm(m.movieNm).includes(key)) set.set(m.movieCd, m);
    }
  }
  return Array.from(set.values());
}

/* ================= 렌더 ================= */
function renderPersonHeader(person){
  $('#personName').textContent = person.peopleNm || '배우';
  $('#personMeta').textContent = (person.repRoleNm ? `분야: ${p
